{{ header }}{{ column_left }}
<div id="content">
    <div class="alert alert-info">
        <i class="fa fa-exclamation-circle"></i>&nbsp;{{ help_paytr_checkout }}
    </div>
    {% if errors is defined %}
        {% for key, errors_m  in errors %}
            <div class="alert alert-danger alert-dismissible"><i
                        class="fa fa-exclamation-circle"></i> {{ errors_message[key] }}
                <button type="button" class="close" data-dismiss="alert">&times;</button>
            </div>
        {% endfor %}
    {% endif %}

    {% if warning_samesite %}
        <div class="alert alert-danger" style="border-left: 5px solid #dc3545;">
            <i class="fa fa-exclamation-triangle fa-lg"></i> 
            <div style="margin-left: 30px;">
                {{ warning_samesite|raw }}
                    <div class="mt-2">
                        <strong>PayTR iFrame API düzgün çalışması için Lax modun aktif olması gerekmektedir!</strong>
                            <ul class="mt-1">
                                <li>System > Settings > Store > Server > Session Samesite Cookie Lax olmalı </li>
                            </ul>
                    </div>
            </div>
        </div>
    {% endif %}

{% if warning_phone %}
  <div class="alert alert-danger">
    <i class="fa fa-exclamation-circle"></i> {{ warning_phone|raw }}
    <div class="mt-2">
                        <strong>DİKKAT: PayTR iFrame API düzgün çalışması için Telefonun aktif olması gerekmektedir!</strong>
                            <ul class="mt-1">
                                <li>System > Settings > Store > Option > Account > Telephone Display ve Telephone Required aktif olmalı !</li>
                            </ul>
                    </div>
  </div>
{% endif %}

{% if warning_adress %}
  <div class="alert alert-danger">
    <i class="fa fa-exclamation-circle"></i> {{ warning_adress|raw }}
    <div class="mt-2">
                        <strong>DİKKAT: PayTR iFrame API düzgün çalışması için Adresin aktif olması gerekmektedir!</strong>
                            <ul class="mt-1">
                                <li>System > Settings > Store > Option > Checkout > Billing Address required ve Use shipping address for billing address aktif olmalı !</li>
                            </ul>
                    </div>
  </div>
{% endif %}


    <div class="page-header">
        <div class="container-fluid">
            <div class="float-end">
                <button type="submit" form="form-payment" data-bs-toggle="tooltip" title="{{ button_save }}" class="btn btn-primary"><i class="fa-solid fa-save"></i></button>
                <a href="{{ back }}" data-bs-toggle="tooltip" title="{{ button_back }}" class="btn btn-light"><i class="fa-solid fa-reply"></i></a></div>
            <h1>{{ heading_title }}</h1>
            <ol class="breadcrumb">
                {% for breadcrumb in breadcrumbs %}
                    <li class="breadcrumb-item"><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
                {% endfor %}
            </ol>
        </div>
    </div>
    <div class="container-fluid">
        <ul class="nav nav-pills mb-3">
            <li class="nav-item"><a href="#tab_api_information" data-bs-toggle="tab" class="nav-link active">{{ tab_general }}</a></li>
            <li class="nav-item"><a href="#tab_order_status" data-bs-toggle="tab" class="nav-link">{{ text_order_status }}</a></li>
            <li class="nav-item"><a href="#tab_module_setting" data-bs-toggle="tab" class="nav-link">{{ text_module_settings }}</a></li>
        </ul>
        <form id="form-payment" action="{{ save }}" method="post" data-oc-toggle="ajax">
            <div class="tab-content">
                <div id="tab_api_information" class="tab-pane fade show active">
                    <div class="card">
                        <div class="card-header"><i class="fa-solid fa-pencil"></i> {{ text_settings }}</div>
                        <div class="card-body">
                            <div class="row mb-3 required">
                                <label for="input_title" class="col-sm-2 col-form-label">{{ entry_title }}</label>
                                <div class="col-sm-10">
                                    <input type="text" id="input_title" name="payment_paytr_checkout_title" value="{{ payment_paytr_checkout_title }}" class="form-control" placeholder="{{ entry_title }}"/>
                                </div>
                            </div>
                            <div class="row mb-3 required">
                                <label for="input_description" class="col-sm-2 col-form-label">{{ entry_description }}</label>
                                <div class="col-sm-10">
                                    <input type="text" id="input_description" name="payment_paytr_checkout_description" value="{{ payment_paytr_checkout_description }}" class="form-control" placeholder="{{ entry_description }}"/>
                                </div>
                            </div>
                            <div class="row mb-3 required">
                                <label for="input_language" class="col-sm-2 col-form-label">{{ entry_test_mode }}</label>
                                <div class="col-sm-10">
                                    <select id="input_language" name="payment_paytr_checkout_test_mode" class="form-select">
                                        <option value="1" {% if payment_paytr_checkout_test_mode == 1 %}selected{% endif %}>{{ entry_test_mode_on }}</option>
                                        <option value="0" {% if payment_paytr_checkout_test_mode == 0 %}selected{% endif %}>{{ entry_test_mode_off }}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3 required">
                                <label for="input_merchant_id" class="col-sm-2 col-form-label">{{ entry_merchant_id }}</label>
                                <div class="col-sm-10">
                                    <input type="text" id="input_merchant_id" name="payment_paytr_checkout_merchant_id" value="{{ payment_paytr_checkout_merchant_id }}" class="form-control" placeholder="{{ entry_merchant_id }}"/>
                                </div>
                            </div>
                            <div class="row mb-3 required">
                                <label for="input_merchant_id" class="col-sm-2 col-form-label">{{ entry_merchant_key }}</label>
                                <div class="col-sm-10">
                                    <input type="text" id="input_merchant_id" name="payment_paytr_checkout_merchant_key" value="{{ payment_paytr_checkout_merchant_key }}" class="form-control" placeholder="{{ entry_merchant_key }}"/>
                                </div>
                            </div>
                            <div class="row mb-3 required">
                                <label for="input_merchant_salt" class="col-sm-2 col-form-label">{{ entry_merchant_salt }}</label>
                                <div class="col-sm-10">
                                    <input type="text" id="input_merchant_salt" name="payment_paytr_checkout_merchant_salt" value="{{ payment_paytr_checkout_merchant_salt }}" class="form-control" placeholder="{{ entry_merchant_salt }}"/>
                                </div>
                            </div>


                            <div class="row mb-3">
  <label class="col-sm-2 col-form-label" for="input-iframe-version">{{ entry_iframe_version }}</label>
  <div class="col-sm-10">
    <select name="payment_paytr_checkout_iframe_version" id="input-iframe-version" class="form-control">
      {% for key, option in iframe_version_options %}
        <option value="{{ key }}" {{ key == payment_paytr_checkout_iframe_version ? 'selected' }}>{{ option }}</option>
      {% endfor %}
    </select>
  </div>
</div>

<div class="row mb-3">
  <label class="col-sm-2 col-form-label" for="input-iframe-theme">{{ entry_iframe_theme }}</label>
  <div class="col-sm-10">
    <select name="payment_paytr_checkout_iframe_theme" id="input-iframe-theme" class="form-control">
      {% for key, option in iframe_theme_options %}
        <option value="{{ key }}" {{ key == payment_paytr_checkout_iframe_theme ? 'selected' }}>{{ option }}</option>
      {% endfor %}
    </select>
  </div>
</div>


                            <div class="row mb-3">
                                <label for="input_language" class="col-sm-2 col-form-label">{{ entry_language }}</label>
                                <div class="col-sm-10">
                                    <select id="input_language" name="payment_paytr_checkout_lang" class="form-select">
                                        {% for key,k in language_arr %}
                                            <option value="{{ key }}" {% if payment_paytr_checkout_lang == key %}selected{% endif %}>{{ k }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="input_total" class="col-sm-2 col-form-label"><span data-bs-toggle="tooltip" title="{{ help_total }}">{{ entry_total }}</span></label>
                                <div class="col-sm-10">
                                    <input type="text" id="input_total" name="payment_paytr_checkout_total" value="{{ payment_paytr_checkout_total }}" class="form-control" placeholder="{{ entry_total }}"/>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="input_module_layout" class="col-sm-2 col-form-label">{{ entry_module_layout }}</label>
                                <div class="col-sm-10">
                                    <select id="input_module_layout" name="payment_paytr_checkout_module_layout" class="form-select">
                                        {% for key,k in module_layout %}
                                            <option value="{{ key }}" {% if payment_paytr_checkout_module_layout == key %}selected{% endif %}>{{ k }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="input_module_status" class="col-sm-2 col-form-label">{{ entry_status }}</label>
                                <div class="col-sm-10">
                                    <select id="input_module_status" name="payment_paytr_checkout_status" class="form-select">
                                        <option value="1" {% if payment_paytr_checkout_status == 1 %}selected{% endif %}>{{ text_enabled }}</option>
                                        <option value="0" {% if payment_paytr_checkout_status == 0 %}selected{% endif %}>{{ text_disabled }}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="input_sort_order" class="col-sm-2 col-form-label">{{ entry_sort_order }}</label>
                                <div class="col-sm-10">
                                    <input type="text" id="input_sort_order" name="payment_paytr_checkout_sort_order" value="{{ payment_paytr_checkout_sort_order }}" class="form-control" placeholder="{{ entry_sort_order }}"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="tab_order_status" class="tab-pane fade">
                    <div class="card">
                        <div class="card-header"><i class="fa-solid fa-pencil"></i> {{ text_order_status }}</div>
                        <div class="card-body">
                            <div class="row mb-3 required">
                                <label for="input_order_status_completed" class="col-sm-2 col-form-label">{{ entry_payment_complete }}</label>
                                <div class="col-sm-10">
                                    <select name="payment_paytr_checkout_order_completed_id" id="input_order_status_completed" class="form-select">
                                        {% if payment_paytr_checkout_order_completed_id == '' %}
                                            <option value='' selected>{{ text_select }}</option>
                                        {% endif %}
                                        {% for order_status in order_statuses %}
                                            <option value="{{ order_status.order_status_id }}" {% if order_status.order_status_id == payment_paytr_checkout_order_completed_id %}selected{% endif %}>{{ order_status.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3 required">
                                <label for="input_order_status_canceled" class="col-sm-2 col-form-label">{{ entry_payment_failed }}</label>
                                <div class="col-sm-10">
                                    <select name="payment_paytr_checkout_order_canceled_id" id="input_order_status_canceled" class="form-select">
                                        {% if payment_paytr_checkout_order_canceled_id == '' %}
                                            <option value='' selected>{{ text_select }}</option>
                                        {% endif %}
                                        {% for order_status in order_statuses %}
                                            <option value="{{ order_status.order_status_id }}" {% if order_status.order_status_id == payment_paytr_checkout_order_canceled_id %}selected{% endif %}>{{ order_status.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="input_order_notify" class="col-sm-2 col-form-label">{{ entry_notify_status }}</label>
                                <div class="col-sm-10">
                                    <select name="payment_paytr_checkout_notify" class="form-select" id="input_order_notify">
                                        <option value="0" {% if payment_paytr_checkout_notify == 0 %}selected{% endif %}>{{ text_disabled }}</option>
                                        <option value="1" {% if payment_paytr_checkout_notify == 1 %}selected{% endif %}>{{ text_enabled }}</option>
                                    </select>
                                    <div class="form-text">{{ help_notify }}</div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="input_order_ins_total" class="col-sm-2 col-form-label">{{ entry_ins_total }}</label>
                                <div class="col-sm-10">
                                    <select name="payment_paytr_checkout_ins_total" class="form-select" id="input_order_ins_total">
                                        <option value="0" {% if payment_paytr_checkout_ins_total == 0 %}selected{% endif %}>{{ text_disabled }}</option>
                                        <option value="1" {% if payment_paytr_checkout_ins_total == 1 %}selected{% endif %}>{{ text_enabled }}</option>
                                        <option value="2" {% if payment_paytr_checkout_ins_total == 2 %}selected{% endif %}>{{ text_ins_total }}</option>
                                    </select>
                                    <div class="form-text">{{ help_ins_total }}</div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="input_order_total" class="col-sm-2 col-form-label">{{ entry_order_total }}</label>
                                <div class="col-sm-10">
                                    <select name="payment_paytr_checkout_order_total" class="form-select" id="input_order_total">
                                        <option value="0" {% if payment_paytr_checkout_order_total == 0 %}selected{% endif %}>{{ text_disabled }}</option>
                                        <option value="1" {% if payment_paytr_checkout_order_total == 1 %}selected{% endif %}>{{ text_enabled }}</option>
                                    </select>
                                    <div class="form-text">{{ help_order_total }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="tab_module_setting" class="tab-pane fade">
                    <div class="card">
                        <div class="card-header"><i class="fa-solid fa-pencil"></i> {{ text_module_settings }}</div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <label for="input_installment_max" class="col-sm-2 col-form-label">{{ entry_max_installments }}</label>
                                <div class="col-sm-10">
                                    <select id="input_installment_max" name="payment_paytr_checkout_installment_number" class="form-select">
                                        {% for key, k in installment_arr %}
                                            <option value="{{ key }}" {% if key == payment_paytr_checkout_installment_number %}selected{% endif %}>{{ k }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="form-text">{{ entry_max_installments_help }}</div>
                                </div>
                            </div>
                            <div id="categoryBasedArea"></div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
    #categoryBasedArea .col-md-3:nth-child(2n) {
        background: #efefef;
    }
</style>

<script type="text/javascript">

    $(document).on('change', '#input_installment_max', function () {
        ajaxCategoryBased(this.value);
    });

    $(window).on('load', function () {
        ajaxCategoryBased($('#input_installment_max').val());
    });

    function ajaxCategoryBased(val) {

        const body = $('#categoryBasedArea');

        if (val == 13) {
            $.ajax({
                url: 'index.php?route=extension/oc_paytr/payment/paytr_checkout.ajaxCategoryBased&user_token={{ user_token }}',
                dataType: 'json',
                beforeSend: function () {
                    body.html('<div style="text-align: center;margin-top: 20px;"><img src="{{ paytr_icon_loader }}" /></div>');
                },
                success: function (json) {
                    let formGroup = '';

                    if (typeof json != "undefined" && json != null) {

                        if (json.result !== false) {
                            let result = json.result;

                            $.each(json.categories, function (ci, cv) {
                                formGroup += '<div class="mb-3 row">';
                                formGroup += '<label for="payment_paytr_checkout_category_installment[' + ci + ']" class="col-sm-4 col-form-label">' + cv + '</label>';
                                formGroup += '<div class="col-sm-8"><select id="payment_paytr_checkout_category_installment[' + ci + ']" name="payment_paytr_checkout_category_installment[' + ci + ']" class="form-select">';

                                $.each(json.installments, function (ii, iv) {
                                    formGroup += '<option value="' + ii + '"';

                                    if (result != null) {
                                        if (result[ci] == ii) {
                                            formGroup += 'selected="selected"';
                                        }
                                    }

                                    formGroup += '>' + iv + '</option>';
                                });

                                formGroup += '</select></div>';
                                formGroup += '</div>';
                            });
                        } else {
                            alert('An error occurred');
                        }
                    }

                    body.html(formGroup);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                }
            });
        } else {
            body.html('');
        }
    }

</script>
{{ footer }}