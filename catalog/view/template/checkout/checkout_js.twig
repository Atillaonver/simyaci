<script type="text/javascript"><!--

var scrllIds = [];
var scrllPars = [];

class Chain {
    constructor() {
        this.start = false;
        this.data = [];
    }
    attach(call) {
        this.data.push(call);

        if (!this.start) {
            this.execute();
        }
    }
    execute() {
        if (this.data.length) {
            this.start = true;

            var call = this.data.shift();

            var jqxhr = call();

            jqxhr.done(function() {
                chain.execute();
            });
        } else {
            this.start = false;
        }
    }
}

var chain = new Chain();

var sMethods= function() {
	chain.attach(function(){
    	return $.ajax({
            url: 'index.php?route=checkout/shipping_method.quote&language={{ language }}',
            dataType: 'json',
            success: function(json) {
            	html = ''; 
            	$('#input-shipping-method').removeClass('is-invalid');
                $('#error-shipping-method').removeClass('d-block');

                if (json['error']) {
                    $('#input-shipping-method').addClass('is-invalid');
                    $('#error-shipping-method').html(json['error']).addClass('d-block');
                }
                if(json['code']){
                	$('#input-shipping-code').val(json['code'])
                }
                var firstJ = 0;
                for (i in json['shipping_methods']) {
                	if (!json['shipping_methods'][i]['error']) {
                			var CODE = $('#input-shipping-code').val()
                			for (j in json['shipping_methods'][i]['quote']) {
		                        html += '<div class="form-check">';
		                        var code = i + '-' + j.replaceAll('_', '-');
		                        html += '<input type="radio" name="shipping_method" value="' + json['shipping_methods'][i]['quote'][j]['code'] + '" id="input-shipping-method-' + code + '"';
								if(firstJ == 0 ){
									firstJ ++;
									html += ' checked';
								}else if (CODE == code){
									html += ' checked';
								}
								
		                        html += '/>';
		                        html += '  <label for="input-shipping-method-' + code + '">' + json['shipping_methods'][i]['quote'][j]['name'] + ' - ' + json['shipping_methods'][i]['quote'][j]['text'] + '</label>';
		                        html += '</div>';
		                    }
	                } else {
	                    html += '<div class="alert alert-danger">' + json['shipping_methods'][i]['error'] + '</div>';
	                }
	            }
            	
            	$('#methods-shipping').html(html);
            	setTimeout(function() {$('#checkout-shipping-method').removeClass('hidden');$('[name="shipping_method"]').trigger("change");}, 500);
            	
            	
             }
		});
	});
}
	
var pMethods = function() {
		chain.attach(function() {
        	return $.ajax({
		            url: 'index.php?route=checkout/payment_method.getMethods&language={{ language }}',
		            dataType: 'json',
		            success: function(json) {
		            	 html = ''; 
		            	$('#input-payment-method').removeClass('is-invalid');
		                $('#error-payment-method').removeClass('d-block');

		                if (json['error']) {
		                    $('#input-payment-method').addClass('is-invalid');
		                    $('#error-payment-method').html(json['error']).addClass('d-block');
		                }
		                
		                if(json['code']){
		                	$('#input-payment-code').val(json['code'])
		                }
		               
		                var firstJ=0;
		                for (i in json['payment_methods']) {
		                    if (!json['payment_methods'][i]['error']) {
		                    	var CODE = $('#input-payment-code').val()
		                        for (j in json['payment_methods'][i]['option']) {
		                            html += '<div class="form-check">';
		                            var code = i + '-' + j.replaceAll('_', '-');

		                            html += '<input type="radio" name="payment_method" value="' + json['payment_methods'][i]['option'][j]['code'] + '" id="input-payment-method-' + code + '"';
									if(firstJ == 0){
										firstJ++;
										 html += ' checked';
									}else if(CODE == code){
										 html += ' checked';
									}
									
									
		                            html += '/>';
		                            html += '  <label for="input-payment-method-' + code + '">' + json['payment_methods'][i]['option'][j]['name'] + '</label>';
		                            html += '</div>';
		                        }
		                    } else {
		                        html += '<div class="alert alert-danger">' + json['payment_methods'][i]['error'] + '</div>';
		                    }
		                }
		             	
		             	$('#methods-payment').html(html)
		             	setTimeout(function() {$('#checkout-payment-method').removeClass('hidden');$('[name="payment_method"]').trigger("change");}, 500);
		             }
				});
		});
}
	
var confirm =  function() {
	$('#checkout-confirm').load('index.php?route=checkout/confirm.confirm&language={{ language }}');
	sameHeight();
}

var scrllDiv = function(id){
	const element = document.getElementById(id);
	element.scrollIntoView({ behavior: "smooth", block: "end", inline: "nearest" });
}

var adrChange = function(elem){ //address changed
    var language = $('#clanguage').val();
    var element = $('#input-'+elem+'-existing');

    elem = elem ? elem : 'register';
    if(elem =='register' || elem  === undefined || elem ==''){
    	return ;	
    }
    
    chain.attach(function() {
      	return $.ajax({
            url: 'index.php?route=checkout/' + elem + '_address.address&language={{ language }}&address_id=' + $(element).val(),
            dataType: 'json',
            success: function(json) {
                console.log('adrChange-success')
                $('#input-'+elem+'-address').removeClass('is-invalid');
                $('#error-'+elem+'-address').removeClass('d-block');

                if (json['redirect']) {
                    location = json['redirect'];
                }

                if (json['error']) {
                    $('#input-'+elem+'-address').addClass('is-invalid');
                    $('#error-'+elem+'-address').html(json['error']).addClass('d-block');
                }

                if (json['success']) {
                    $('#alert').prepend('<div class="alert alert-success alert-dismissible"><i class="fa-solid fa-circle-check"></i> ' + json['success'] + ' <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
                    
                    switch(elem){
                    	case 'shipping':
                    		sMethods();
                    		break;
                    	case 'payment':
                    		sMethods();
                    	default:
                    		confirm();	
                    }
                   	
                }
            }
        });
    });
}

var sameHeight = function(){
	$('.same-height').each(function(ind,elem){
		if($(this).prev().height()>$(this).prev().height()){
			$(this).css('height',$(this).prev().height()+'px');	
		}else{
			$(this).css('height','auto');	
		}
		
	});
}


//--></script>
